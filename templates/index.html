<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTDLP体験ゲーム</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background: #f7f7f9; margin: 0; }
    .wrap { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .panel { background: #eef4ff; border: 1px solid #dbe7ff; border-radius: 12px; padding: 14px 16px; }
    .question { background: #f2f6fc; border: 1px solid #e5eefc; min-height: 140px; white-space: pre-wrap; border-radius: 12px; padding: 14px 16px; }
    .oldlog { margin-top: 10px; color: #6b7280; font-size: 14px; max-height: 240px; overflow-y: auto; white-space: pre-wrap; }
    form { display: flex; gap: 8px; margin-top: 12px; }
    input[type="text"] { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 16px; }
    button { padding: 10px 14px; border: none; border-radius: 10px; font-weight: 600; }
    .send { background: #2563eb; color: #fff; }
    .reset { background: #eef2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>MTDLP体験ゲーム</h1>

    {# --- サーバーからの履歴を取得 --- #}
    {% set last = history[-1] if history and history[-1].role == 'system' else None %}
    {% set last_text = last.text if last else '' %}

    {# 「\nQ:」で最初に分割。前半=前の応答/説明、後半=質問 #}
    {% set parts = last_text.split('\nQ:') %}
    {% set beforeQ = parts[0].strip() %}
    {% set question = ('Q:' + parts[1]).strip() if parts|length > 1 else last_text.strip() %}

    <div class="panel">
      <div class="question">
        {{ question }}
      </div>
      <div class="oldlog">
        {# 直近以外の履歴（ユーザー発言も含めて） #}
        {% for m in history[:-1] %}
          {{ m.text }}
          {% if not loop.last %}\n\n{% endif %}
        {% endfor %}
        {# 直近システム出力の前半（Q:の前）も過去ログに入れる #}
        {% if beforeQ %}{% if history[:-1] %}\n\n{% endif %}{{ beforeQ }}{% endif %}
      </div>
    </div>

    <form method="POST">
      <input type="text" name="user_input" placeholder="ここに入力して送信" autofocus />
      <button class="send" type="submit">送信</button>
      <a class="reset" href="{{ url_for('reset') }}"><button class="reset" type="button">リセット</button></a>
    </form>
  </div>

  <script>
    // ページ遷移直後は必ず一番上に表示
    window.scrollTo({ top: 0, behavior: "instant" });
  </script>
</body>
</html>
